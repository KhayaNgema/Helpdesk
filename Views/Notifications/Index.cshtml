@model IEnumerable<Helpdesk.Models.Notification>

@{
    ViewBag.Title = "Index";
}

<style>
    .notification-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }


    .unread-notification {
        font-weight: bold;
    }



    .notification-item {
        cursor: pointer;
        border-bottom: 1px solid #eee; /* Add lighter gray horizontal borders */
        margin-bottom: 0;
        border-radius: 1px; /* Add border radius for a rounded appearance */
        transition: background-color 0.3s ease, transform 0.3s ease, box-shadow 0.3s ease; /* Add box-shadow property for shadow effect */
        padding: 10px;
        height: 50px;
    }

        .notification-item:hover {
            background-color: #e7eff0;
            transform: translateY(-3px); /* Move the element up by 3 pixels on hover for a 3D effect */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); /* Add dark shadow on hover */
        }



    .unread-notification {
        font-weight: bold;
    }

    .vertical-buttons {
        position: fixed;
        top: 120px;
        right: 0;
        z-index: 1000;
        display: flex;
        flex-direction: column;
        padding: 20px;
        margin-right: 20px;
    }

    .vertical-button {
        padding: 10px;
        margin-bottom: 10px;
        cursor: pointer;
        border: none;
        text-align: left;
        transition: background-color 0.3s ease;
        border-radius: 8px;
        position: relative;
        background-color: #030319; /* Button background color */
    }

        .vertical-button:hover {
            background-color: #e7eff0;
        }

        .vertical-button::before {
            content: attr(data-tooltip);
            background-color: #030319; /* Tooltip background color */
            color: #fff;
            border-radius: 4px;
            padding: 10px;
            position: absolute;
            top: 50%;
            right: calc(100% + 10px);
            transform: translateY(-50%);
            z-index: 999;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            width: 80px; /* Adjusted width of the tooltip background */
           
        }

        .vertical-button:hover::before {
            opacity: 1;
        }

        .vertical-button i {
            color: #fff;
        }


        .vertical-button:hover i {
            color: #030319;
        }


    .search-container {
        position: fixed;
        top: 50px; /* Adjust the top position to add more space between the fixed container and the top of the screen */
        left: 0;
        width: 100%;
        background-color: #EDFBFF;
        padding: 8px;
        z-index: 1000;
        box-sizing: border-box;
        padding: 20px;
    }

    #notificationSearch {
        width: calc(100% - 60px); /* Increase the width by changing the value */
        border: 2px solid #6ff0dc; /* Add a border and adjust its style */
        border-radius: 10px;
        outline: none; /* Removed outline for better aesthetics */
        padding: 10px;
        margin-left: 640px; /* Adjust the left margin to move the search bar a bit to the right */
    }



    .search-results-not-found {
        color: #000000;
        font-style: italic;
    }

    .container {
        position: relative;
        z-index: 1;
        margin-top: 0px; /* Adjust the margin as needed */
        padding-top: 22px; /* Adjust the padding as needed */
    } 

        .search-results-not-found {
        color: #000000;
        display: none;
        position: fixed;
        top:0%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-style: italic;
    }


</style>

<div class="container">

    <div class="vertical-buttons">
        <button class="vertical-button" data-tooltip="New" onclick="redirectTo('/Notifications/Create')"><i class="fas fa-plus"></i></button>
        <button class="vertical-button" data-tooltip="Inbox" onclick="redirectTo('/YourControllerName/YourActionNameForInbox')"><i class="fas fa-inbox"></i></button>
        <button class="vertical-button" data-tooltip="Sent" onclick="redirectTo('/YourControllerName/YourActionNameForSent')"><i class="fas fa-paper-plane"></i></button>
        <button class="vertical-button" data-tooltip="Starred" onclick="redirectTo('/YourControllerName/YourActionNameForStarred')"><i class="fas fa-star"></i></button>
        <button class="vertical-button" data-tooltip="Deleted" onclick="redirectTo('/YourControllerName/YourActionNameForDeleted')"><i class="fas fa-trash-alt"></i></button>
    </div>

    <script>
        function redirectTo(url) {
            window.location.href = url;
        }
    </script>


    <div class="search-container">
        <input type="text" id="notificationSearch" placeholder="Search notifications by sender, subject, or date..." oninput="searchNotifications()">
        <p class="search-results-not-found">No search results found. Please check your spelling or accuracy of your search.</p>
    </div>


    <ul id="notificationList" class="list-group">
        <!-- Existing notifications rendered on the server-side -->
        @foreach (var notification in Model.OrderByDescending(x => x.NotificationDate))
        {
            <li class="list-group-item notification-item @(notification.IsRead ? "" : "unread-notification")"
                data-notification-id="@notification.NotificationId"
                data-is-read="@notification.IsRead">
                <div class="notification-content">
                    <p class="notification-sender">@notification.Sender.FirstName @notification.Sender.LastName</p>
                    <p class="notification-subject">@notification.NotificationSubject</p>
                    <p class="notification-date" data-notification-date="@notification.NotificationDate" data-time-zone-id="UTC">
                        @FormatNotificationDate(notification.NotificationDate, "UTC")
                    </p>
                </div>
            </li>
        }
    </ul>
</div>



<!-- Include jQuery and SignalR scripts if not already included -->
<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/3.1.11/signalr.min.js"></script>

<script>
    $(document).ready(function () {
        // Establish a connection to the SignalR hub
        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/notificationHub") // Adjust the URL based on your setup
            .build();

        // Define a function to handle received notifications
        connection.on("receiveNotification", function (notification) {
            // Handle the received notification here
            console.log("Received notification:", notification);

            // Update UI or perform other actions as needed
            updateUIWithNotification(notification);
        });

        // Start the SignalR connection
        connection.start()
            .then(function () {
                console.log("SignalR connected");
            })
            .catch(function (err) {
                console.error("Error connecting to SignalR:", err);
            });

        function updateUIWithNotification(notificationItem) {
            // Create HTML for the new notification
            var newNotificationHtml = `
        <li class="list-group-item notification-item ${(notificationItem.IsRead) ? "" : "unread-notification"}"
            data-notification-id="${notificationItem.NotificationId}"
            data-is-read="${notificationItem.IsRead}">
            <div class="notification-content">
                <p class="notification-sender">${notificationItem.Sender.FirstName} ${notificationItem.Sender.LastName}</p>
                <p class="notification-subject">${notificationItem.NotificationSubject}</p>
                <p class="notification-date">${formatNotificationDate(notificationItem.NotificationDate, "UTC")}</p>
            </div>
        </li>`;

            // Prepend the new notification to the list
            $("#notificationList").prepend(newNotificationHtml);

            // Update the time display
            updateTimeDisplay();
        }


        // Handle click events on notification items
        $(document).on("click", ".notification-item", function () {
            const notificationId = $(this).data("notification-id");
            const isRead = $(this).data("is-read");

            if (!isRead) {
                $(this).data("is-read", true);
                $(this).removeClass("unread-notification");
                // Perform other actions for marking the notification as read
            }

            window.location.href = `/Notifications/Details/${notificationId}`;
        });

     
    });

    function searchNotifications() {
        var searchTerm = $('#notificationSearch').val().toLowerCase();

        // Hide the "Search results not found" message initially
        $('.search-results-not-found').hide();

        // Iterate through each notification item
        $('#notificationList .notification-item').each(function () {
            var sender = $(this).find('.notification-sender').text().toLowerCase();
            var subject = $(this).find('.notification-subject').text().toLowerCase();
            var date = $(this).find('.notification-date').text().toLowerCase();

            // Check if the search term matches any of the notification details
            if (sender.includes(searchTerm) || subject.includes(searchTerm) || date.includes(searchTerm)) {
                $(this).show(); // Display the matching notification
            } else {
                $(this).hide(); // Hide the non-matching notification
            }
        });

        // Show "Search results not found" if no matching notifications are found
        if ($('#notificationList .notification-item:visible').length === 0) {
            $('.search-results-not-found').show();
        }
    }

    $(document).ready(function () {
        // Existing JavaScript code remains unchanged

        // Dynamic search bar functionality
        $('#notificationSearch').on('input', searchNotifications);
    });
</script>

<script>
    // Function to update the time display
    function updateTimeDisplay() {
        $(".notification-date").each(function () {
            var notificationDate = new Date($(this).data("notification-date"));
            var timeZoneId = $(this).data("time-zone-id");
            var formattedDate = formatNotificationDate(notificationDate, timeZoneId); // Use consistent case
            $(this).text(formattedDate);
        });
    }

    // Periodically update the time display (every minute in this example)
    setInterval(updateTimeDisplay, 60000); // 60000 milliseconds = 1 minute
</script>


@functions {
    public string FormatNotificationDate(DateTime notificationDate, string timeZoneId)
    {
        var timeZone = TimeZoneInfo.FindSystemTimeZoneById(timeZoneId);
        var now = TimeZoneInfo.ConvertTimeFromUtc(DateTime.UtcNow, timeZone);
        var timeDifference = now - notificationDate;

        if (timeDifference.TotalSeconds <= 60) // Display "Just now" for the first 60 seconds
        {
            return "Just now";
        }
        else if (timeDifference.TotalMinutes < 60)
        {
            var minutes = (int)timeDifference.TotalMinutes;
            return $"{minutes} minute{(minutes == 1 ? "" : "s")} ago";
        }
        else if (timeDifference.TotalHours < 24)
        {
            var hours = (int)timeDifference.TotalHours;
            return $"{hours} hour{(hours == 1 ? "" : "s")} ago";
        }
        else if (timeDifference.TotalDays < 1)
        {
            return notificationDate.ToString("HH:mm");
        }
        else if (timeDifference.TotalDays < 2)
        {
            return "Yesterday";
        }
        else if (timeDifference.TotalDays < 3)
        {
            return notificationDate.ToString("MM/dd");
        }
        else
        {
            var days = (int)timeDifference.TotalDays;
            return days <= 10
                ? $"{days} day{(days == 1 ? "" : "s")} ago"
                : notificationDate.ToString("MMM dd...");
        }
    }
}



















